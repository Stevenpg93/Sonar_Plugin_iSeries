# SonarQube Plugin Development Environment

## Architecture Overview

This workspace is a complete **SonarQube plugin development environment** with:
- **Plugin source**: `plugin-todo-check/` - Custom Java plugin that detects `TODO` comments in code
- **Demo project**: `demo-project/` - Test project for plugin validation
- **Docker setup**: SonarQube Community + PostgreSQL via `docker-compose.yml`
- **Plugin loading**: `./plugins/` directory is mounted to `/opt/sonarqube/extensions/plugins` in the container

Key architectural constraint: **SonarQube does NOT support hot-reload**. Every plugin change requires a container restart via `./scripts/restart-sonarqube.sh`.

## Plugin Architecture (SonarQube API)

All plugins must implement `org.sonar.api.Plugin` interface and register extensions in the `define()` method:

```java
// TodoCheckPlugin.java - Entry point
context.addExtensions(TodoRulesDefinition.class, TodoSensor.class);
```

Two main components:
1. **RulesDefinition**: Declares rules, severity, and metadata (see [TodoRulesDefinition.java](plugin-todo-check/src/main/java/com/example/sonar/todo/TodoRulesDefinition.java))
2. **Sensor**: Analyzes files during scans and creates issues (see [TodoSensor.java](plugin-todo-check/src/main/java/com/example/sonar/todo/TodoSensor.java))

## Corporate Network Constraints

This workspace is configured for **Bancolombia's corporate network**:
- All Docker images use `artifactory.apps.bancolombia.com/` prefix
- Maven repos point to `https://artifactory.apps.bancolombia.com/maven-bancolombia` ([pom.xml](plugin-todo-check/pom.xml#L45-L57))

## Developer Workflows

### Complete Bootstrap (First Time)
```bash
./scripts/bootstrap-demo.sh  # Or: make bootstrap
```
This end-to-end script: starts Docker, builds plugin, restarts SonarQube, compiles demo, creates project/profile, activates rule, and runs scan.

### Plugin Development Cycle (Iterate Fast)
```bash
./scripts/build-plugin.sh    # Builds JAR, copies to ./plugins/ (fallback to offline if Maven fails)
./scripts/restart-sonarqube.sh  # Restart container to load plugin
./scripts/scan-demo.sh       # Re-scan demo project
```
### Available Make Targets
See [Makefile](Makefile) for shortcuts:
- `make plugin` - Build plugin
- `make restart` - Restart SonarQube
- `make scan` - Scan demo project (reads token from `.sonarqube/sonar.token`)
- `make reset` - Nuclear option: `docker-compose down -v` + clean state

## Plugin Manifest Requirements

SonarQube reads plugin metadata from `MANIFEST.MF` (generated by Maven from [pom.xml](plugin-todo-check/pom.xml#L14-L22) properties):
- `Plugin-Key`: Unique identifier (e.g., `todo-check`)
- `Plugin-Class`: Fully qualified class name of your `Plugin` implementation
- `Sonar-Version`: Minimum SonarQube version (this project uses `9.9`)

## Project-Specific Conventions

### Quality Profile Activation
New rules are **inactive by default**. After deploying a plugin:
1. Go to **Administration → Quality Profiles → Cobol**
2. Create or edit a profile
3. Activate rule from repository `todo-check`, rule key `todo-comment`

### Sensor Pattern (File Analysis)
See [TodoSensor.java](plugin-todo-check/src/main/java/com/example/sonar/todo/TodoSensor.java) for the standard pattern:
```java
FilePredicates predicates = fileSystem.predicates();
Iterable<InputFile> files = fileSystem.inputFiles(
  predicates.and(
    predicates.hasLanguage("java"),  // Language filter
    predicates.hasType(Type.MAIN)    // Exclude test files
  )
);
```

Always catch `IOException` when reading file contents - don't block the entire analysis if one file fails.

## Key Files Reference

- [GUIA-PLUGIN-SONARQUBE.md](GUIA-PLUGIN-SONARQUBE.md) - Comprehensive guide (Spanish) with troubleshooting
- [docker-compose.yml](docker-compose.yml) - Docker setup with plugin volume mount
- [plugin-todo-check/pom.xml](plugin-todo-check/pom.xml) - Plugin build configuration (system dependency to `sonarqube.jar`)
- [scripts/](scripts/) - All automation scripts (prefer these over manual commands)

## Testing & Verification

1. **Check plugin loaded**: `./scripts/logs.sh` and search for plugin name
2. **UI verification**: Administration → System → Installed Plugins
3. **Issue creation**: Run scan and verify issues appear in project dashboard (http://localhost:9000)

## Common Pitfalls

- **Forgot to restart after plugin change** - Remember: NO hot-reload!
- **Rules not activated** - Check Quality Profile settings
- **Token not found** - Bootstrap script saves token to `.sonarqube/sonar.token`